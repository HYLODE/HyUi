# Deployment


## Setup environment

- Clone the repository on an NHS server `git clone https://github.com/HYLODE/HyUi.git`.
- Configure your `.env` variables using `.env.example` as a template.
- Configure `docker/initialise/.env` variables using `docker/initialise/.env.example.`

### Using the http cache

We use [Varnish](https://varnish-cache.org) as a HTTP cache to speed up some of the slower API calls made by the front end. The default behaviour provided by Varnish is to cache everything, which is the approach we are following here.

The cache is brought up with other services and is represented in `compose.yml`, which uses `docker/cache/Dockerfile`.
The only change required to utilise caching is within the base `.env` file. The `WEB_API_URL` environment variable should be set to `http://cache:8000`, or `http://cache:8000/mock` for local development.

Cache configuration is set in `cache/default.vcl` and contains very minimal additions with respect to a basic varnish configuration.

The first request made to an uncached API endpoint will not see any speed up - subsequent requests within the time to live (TTL) of an object will use the cached object and will see a speedier response.

Additional configuration is provided for endpoints that absolutely must return live data from the API. Add `X-Varnish-Nuke:1` to the **request** header will clear the cache for the current endpoint and force a live query of the API.

By relying on the setting of cached object TTL via request/response headers and the skipping/clearing of the cache with an additional header, the hope is that developers should not need to interact with `default.vcl`.

#### Altering the lifetime of cached objects
In the absence of an explicit setting, Varnish defaults to a 2 minute TTL for cached objects. This default is overriden in this case and is set to 5 minutes (300 seconds) via response headers in `api/src/api/dependencies.py`. This is then added as a dependency in `api/src/api/main.py` to the `app` and `mock_router` `FastAPI` instances.

## Run the Docker Compose services

In the base directory (containing `compose.yml`)

```sh
docker compose --project-name [project name] up --build
```

Ensure that you use a unique name for your `[project name]`. The production service should be named `hyui-prod`.

## Initialise services

This should be done the first time you stand up the services. It populates the Baserow database with the tables and static data required to run the rest of the HyUi services.

```sh
./bin/initialise.sh --operation baserow
```

## Stop And Remove Docker Containers

```sh
docker compose --project-name [project name] down
```
